---
title: "Multivariable Surival Anlaysis"
author: "Abdirasak Egeh"
date: "2024-11-20"
output:  
  html_document:
    code_download: true 
    code_folding: show
    toc: true 
    toc_float: true 
    theme: readable 
    highlight: zenburn

---
# Information about the data set 

This retrospective cohort study included data of patients registered, between January 1, 2000 and December 31, 2017, in the waiting list of São Paulo State Organ Allocation System (SP-OAS) /Brazil. SP-OAS has a database that holds over 10 years of information and provides a good sample of the Brazilian transplant population. Indeed, of 5,923 kidney transplants performed in the country in 2018, one third of them (2,095) were carried out in the state.

SP-OAS adopts a policy of regional allocation, centralized and controlled organ distribution, and decentralized organ procurement and harvesting. SP-OAS serves as the state´s organ transplantation system and operates a single database of the entire transplant population in the state, but patients from the various transplant groups and dialysis centers are divided into 4 sub-regional waiting lists (FUNDERP; UNICAMP; UNIFESP; and HCFMUSP) according to location.

# Task: 

Is there a significant difference in waiting time till kidney transplant between patients who were listed for a kidney transplant in the state capital (i.e. subregions UNIFESP and HCFMUSP) and those who were listed for a kidney transplant elsewhere (i.e. subregions FUNDERP and UNICAMP)?


```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Libararies 
library(dplyr)
library(tidyverse)
library("survival")
ktransplant <- read.csv("transplant.csv")

```



# Exploring the data

# Variables of interest

 - Id: 	 Unique identifier for patient
 - sex : 	Sex of patient
 - underline_disease	The cause of the kidney disease  
 - diabetes :	Whether the patient has diabetes (0=diabetes; 1=no diabetes) 
    Blood_type:	Blood type of patient
 - prior_transplant:	Whether the patient has had a prior kidney transplant
 - subregion	Which subregion the patient is from
 - outcome:	Outcome for patient (0= patient is still on the transplant list;   1=patient had transplant; 2=patient died while still on the transplant      list, before receiving a transplant; 3=patient was removed from the   ransplant list) 


```{r}
View(head(ktransplant))
nrow(ktransplant)
```

### Total waiting times 

The total waiting times, which include censored observations, are stored in different variables and need to be consolidated into a single variable for the analysis.

 Different time variables: 
 
  - time_transplant: 	For those patients who had a transplant, how long they   were on the list before their transplant (measured in days)
 - time_study_end: 	For those patients still on the transplant list at the    end of the study, how long they had been on the transplant list (measured   in days)
 - time_death:	For those patients who died, how long they were on the list    before their death (measured in days)
 - time_removal: For those patients who were remobed from the transplant      list, how long they were on the transplant list before their removal        (measured in days) 
 
 Likely, time_total variable has no missing. Hence,time is recorded for all study participants. 

```{r}

ktransplant$time_total <- coalesce(ktransplant$time_transplant, 
                                   ktransplant$time_removal, 
                                   ktransplant$time_death, 
                                   ktransplant$time_study_end)

summary(ktransplant$time_total)
length(ktransplant$time_total)


```

### Grouping the varaibles into two main groups.
We now group the study participants to the two different locations we are interested in studying. The total number of observations in the two groups we have just created, should add up to the total of 48152, which the total number of observations in the study.

```{r}
ktransplant$capital <- ifelse(ktransplant$subregion == "UNIFESP" | ktransplant$subregion == "HCFMUSP", "0", NA) # These NA values will appear 
ktransplant$other <- ifelse(ktransplant$subregion == "FUNDERP" | ktransplant$subregion == "UNICAMP", "1", NA)

## Double checking if the totAl number of rows for both "Capital" and "Other" add up to the total number of both sub groups.

table(ktransplant$capital)
table(ktransplant$other)  

# Creating a new factor variable that contains two levels 0,1 with the labels "other and capital". I found this easier for my further analyses 
#library(dplyr)

ktransplant$regions <- coalesce(ktransplant$capital, ktransplant$other)
summary(ktransplant$regions)
ktransplant$Factorregions <- factor(ktransplant$regions, 
                                    levels = c(0, 1), 
                                    labels = c("Capital", "elsewhere"))
table(ktransplant$Factorregions) # Checking if the levels are correct and represent their corresponding groups.
#### 


table(ktransplant$Factorregions)
```
### Recoding the event and censored data

```{r}
 
table(ktransplant$Transplant_Y_N)
# checking original levels 
#original labels, "Sim" and "N\xe3o", are in spanish

ktransplant$Transplant_Y_N <- recode(ktransplant$Transplant_Y_N, "Sim" = "1", "N\xe3o" = "0")

# Storing the outcome as numeric 
# 1 = event , 0= censored 
ktransplant$Transplant_Y_N <- as.numeric(as.character(ktransplant$Transplant_Y_N))


levels(ktransplant$Transplant_Y_N) # checking the new levels 
View(ktransplant$Transplant_Y_N)
str(ktransplant$Transplant_Y_N)
table(ktransplant$Transplant_Y_N)
```


### Descriptive statistics
 As the Kablan Meier Curve bellow shows, patiens registered in the Capital have a higher probability of recieving a kidney transplant compared to people registered eleswhere, and this difference is also statitically segnificant.
 
 In Capital: 36,958 patients, 9,412 transplant events, median time to event = ~8.8 years (3216 days). Elsewhere: 11,195 patients, 4,320 events, median = ~5.2 years (1893 days). In summary, patients outside the capital had shorter median times to transplant compared to those in the capital.

```{r}
library(survival)
library(survminer)
#library(survminer)
kmsubgroups <- survfit(Surv(time_total, Transplant_Y_N) ~ Factorregions, data=ktransplant)
kmsubgroups
#quantile(kmsubgroups,0.70,conf.int = F)
#abline(h=0.5, col="red")
ggsurvplot(kmsubgroups, xlim= c(0,7000), break.x.by=1000,
           ylab="% Not Transplanted", xlab="Time(days)",
           legend.labs=c("Elsewhere", "Capital"),
           legend.title="",surv.scale = "percent",
           palette = c("blue", "red"),
           title = "Transplant Probability"
           )
```
### Displaying Risk Tables 

```{r}
library(survival)
library(survminer)
kmsubgroups <- survfit(Surv(time_transplant, Transplant_Y_N) ~ Factorregions, data=ktransplant)

ggsurvplot(kmsubgroups, xlim= c(0,7000), break.x.by=1000,
           ylab="Transplant Probability", xlab="Time(days)",
           pval = TRUE, risk.table = TRUE, 
           risk.table.title="",
           censor = TRUE, censor.size = 3, censor.shape = "|",
           legend.labs=c("Elsewhere", "Capital"),
           legend.title="",surv.scale = "percent",
           palette = c("blue", "red"),
           title = "Transplant Probability",
           risk.table.height = .40)
summary(kmsubgroups, times = seq(0,7000,1000))
```

## Basic COX model

### Interpretation

Null hpothesis: The HR =1
alternative hypothesis: H=/= 1

Patients outside the Capital had about a 67% higher chance (hazard) of receiving a transplant at any given time compared to Capital patients. This result is highly significant and unlikely to be random. The model isn’t very strong at prediction (concordance 0.557), but it clearly shows regional differences in transplant access.

```{r}
cox.regions <- coxph(Surv(time_total, Transplant_Y_N) ~ Factorregions, data=ktransplant)
summary(cox.regions)
```

## COX advanced
```{r}

cox.regions2 <- coxph(Surv(time_total, Transplant_Y_N) ~ Factorregions + sex + prior_transplant + age_at_list_registration, data=ktransplant)

summary(cox.regions2)
# Extracting log hazard ratios
log_hr <- coef(cox.regions2)
# Computing the negative exponent hazard ratios
neg_exp_hr <- exp(-log_hr)
# Computing 95% confidence intervals for negative exponent hazard ratios
neg_exp_ci <- exp(confint(cox.regions2))
neg_exp_ci
```
Cox propotional hazards reggression

Null hpothesis: The HR =1
alternative: H=/ 1

After adjusting for sex, prior transplant status, and age, patients outside the Capital had a 63% higher chance of receiving a transplant compared to those in the Capital (HR = 1.63, 95% CI: 1.58–1.69). Males (HR = 1.20, 95% CI: 1.16–1.24) and patients without a prior transplant (HR = 1.31, 95% CI: 1.24–1.38) also had higher hazards of transplant. In contrast, increasing age was associated with a reduced likelihood of transplant (HR per year = 0.98, 95% CI: 0.978–0.980).

### Model analysis
Both region and age at listing are strong, independent predictors of time to transplant. Sex is borderline, and prior transplant status doesn’t add much by itself. However, the overall multivariable model fits substantially better than using region alone, so adjusting for these covariates is justified.

```{r}
cox.zph(cox.regions2)
anova(cox.regions, cox.regions2, test = "LRT") # comparing the two models 

```


